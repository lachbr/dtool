#
# Makefile rules for compiling SoftImage character models.
#

ifeq ($(SOFT2EGG),)
  SOFT2EGG = soft2egg
endif

ifeq ($(SOFT2EGG_CLEAN),)
  SOFT2EGG_CLEAN = soft2egg-clean
endif

ifeq ($(SCENE_PREFIX),)
  SCENE_PREFIX = $(CHAR_NAME)-
endif

ifeq ($(DATABASE_DIR),)
  DATABASE_DIR = $(SOURCE_ROOT)/$(DIR_NAME)
endif

ifeq ($(SOFT_SCENE_DIR),)
  SOFT_SCENE_DIR = $(DATABASE_DIR)/SCENES
endif

ifeq ($(SOFT_MODEL_PATTERN),)
  SOFT_MODEL_PATTERN = $(SCENE_PREFIX)$(MODEL_NAME).*.dsc
endif

ifeq ($(SOFT_ANIM_PATTERN),)
  SOFT_ANIM_PATTERN = $(SCENE_PREFIX)$(ANIM).*.dsc
endif

# CHAN_DIR and WIRE_DIR are names inherited from Makefile.a2egg.rules.
# Makefile.char-egg.rules expects these to contain sensible values,
# so we feed them both the SOFT_SCENE_DIR directory.
CHAN_DIR = $(SOFT_SCENE_DIR)
WIRE_DIR = $(SOFT_SCENE_DIR)

# Similarly for WIRE_PATTERN and CHAN_PATTERN.
WIRE_PATTERN = $(SOFT_MODEL_PATTERN)
CHAN_PATTERN = $(SOFT_ANIM_PATTERN)

ifneq ($(TESS_LEVELS)$(QTESS_LEVELS),)
  # If we are tesselating, we must force the nurbs model generation.
  ifeq ($(NURBS_OPTS),)
    NURBS_OPTS = -n
  endif
endif

S2E_RULE = $(UNOPT)$(EGG_NAME)-$(MODEL).egg : $(WIRE_FILE) maps
S2E = $(SOFT2EGG_CLEAN) -M $@ -d $(DATABASE_DIR) -t maps

S2C_RULE = $(UNOPT)$(CHAN_FILE_PREFIX)$(ANIM)$(CHAN_FILE_SUFFIX).egg : $(FIND_CHAN_FILES)
S2C = $(SOFT2EGG) -a -A $@ -d $(DATABASE_DIR) -s $(notdir $<) $(S2C_OPTS)

SOFT_MODEL = $(notdir $(WIRE_FILE))

MAKE_POLY_MODEL = $(S2E) -s $(SOFT_MODEL) $(POLY_OPTS) $(S2E_OPTS)
MAKE_NURBS_MODEL = $(S2E) -s $(SOFT_MODEL) $(NURBS_OPTS) $(S2E_OPTS)
MAKE_TX_MODEL = a2egg -nsk -m $@ $(MAKE_TX_OPTS) $(TX_WIRE_FILE)


include $(DTOOL)/inc/Makefile.char-egg.rules


